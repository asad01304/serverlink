#!/bin/bash

# this script tries to select the 'best' drush version available to be run

unset set_drush

self_bin=`readlink -e "$0"`
curr_dir=`dirname "$self_bin"`
devpanel_dir=`readlink -e "$curr_dir/../.."`

lib_file="$devpanel_dir/lib/functions"
source "$lib_file" 2>/dev/null

home_1_drush="$HOME/.drush/drush"
home_2_drush="$HOME/.drush/drush/drush"
devpanel_drush="$devpanel_dir/bin/packages/drush/drush"

# first check for drush on the user directory
# if not found, and there isn't another drush in PATH, fallback to
#  ...the drush version shipped with devPanel
if [ -f "$home_1_drush" -a -x "$home_1_drush" ]; then
  hash -p "$home_1_drush" drush
  set_drush=1
elif [ -f "$home_2_drush" -a -x "$home_2_drush" ]; then
  hash -p "$home_2_drush" drush
  set_drush=1
else
  if [ $EUID -ne 0 ]; then
    # check if there's a specific version of drush defined for this vhost
    drush_version=$(get_vhost_key_value "app:0:_:drush_version" 2>/dev/null)
    if [ $? -eq 0 ]; then
      tmp_drush_bin="$devpanel_dir/bin/packages/drush-$drush_version/drush"
      if [ -f "$tmp_drush_bin" -a -x "$tmp_drush_bin" ]; then
        # if a specific version is defined and the binary is available, then
        # use it
        hash -p "$tmp_drush_bin" drush
        set_drush=1
      else
        echo "Warning: drush version $drush_version specified but binary is missing" 1>&2
      fi
    fi
  fi

  if [ -z "$set_drush" -a -x "$devpanel_drush" ]; then
    hash -p "$devpanel_drush" drush
  elif [ -z "$set_drush" ] && hash drush &>/dev/null && [ "`hash -t drush`" == $0 ]; then
    hash -p "$devpanel_drush" drush
  fi
fi

php_home_bin="$HOME/bin/php-cgi"
if [ -f "$php_home_bin" -a -x "$php_home_bin" ]; then
  # if the user has a ~/bin/php-cgi link on $HOME
  if [ -L "$php_home_bin" ]; then
    real_php_bin=$(readlink -e "$php_home_bin")
    real_php_dir="${real_php_bin%/*}"

    # check if there's a php-cli and php respectively on the real PHP dir
    # and use the first one found
    php_cli="$real_php_dir/php-cli"
    php_bin="$real_php_dir/php"
    if [ -f "$php_cli" -a -x "$php_cli" ]; then
      php_exec_bin="$php_cli"
    elif [ -f "$php_bin" -a -x "$php_bin" ]; then
      php_exec_bin="$php_bin"
    fi
  else
    php_exec_bin="$php_home_bin"
  fi
fi
    
if [ -n "$php_exec_bin" ]; then
  export DRUSH_PHP="$php_exec_bin"
fi

drush "$@"
