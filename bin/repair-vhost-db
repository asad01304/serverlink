#!/bin/bash

usage() {
  echo "Usage: $(basename "$0") <db_name>

  This command runs a mysql repair on the main site database (when called
  without arguments). 
  
  When called with one argument it runs mysqlcheck on the specified
  database.
"
  exit 1
}

[ -n "$1" -a "$1" == "-h" ] && usage

if ! hash mysqlcheck &>/dev/null; then
  echo "Error: missing mysqlcheck command" 1>&2
  exit 1
fi

self_bin=$(readlink -e "$0")
dir=$(dirname "$self_bin")
sys_dir=$(readlink -e "$dir/..")

lib_file="$sys_dir/lib/functions"
if ! source "$lib_file"; then
  echo "Error: unable to source lib file $lib_file" 1>&2
  exit 1
fi

if [ -z "$1" ]; then
  db_name=$(get_apache_metadata_value "$sys_dir" 'app:0:_:db_name')
  if [ $? -ne 0 -o -z "$db_name" ]; then
    error "unable to determine web site main database"
  fi
else
  db_name="$1"
fi

echo "Running a repair on database $db_name..."
sleep 2
run_verbose mysqlcheck -r "$db_name"
exit_code=$?
if [ $exit_code -eq 0 ]; then
  echo
  echo "Successfully finished repair of database $db_name"
fi

exit $exit_code
