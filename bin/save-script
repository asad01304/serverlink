#!/bin/bash

TARGET_DIR="$HOME/bin/custom-scripts"

usage() {
  echo "Usage: `basename "$0"` <basename>

Saves the script to the target dir ($TARGET_DIR) using the specified
basename, and makes the script executable.
"
  exit 1
}

[ $# -eq 0 -o -z "$1" ] && usage

umask 077
TMPDIR="$HOME/tmp"
TMP_DIR="$TMPDIR"
export TMPDIR TMP_DIR

target_file="$TARGET_DIR/`basename "$1"`"

if [ ! -d "$TMPDIR" ] && ! mkdir "$TMPDIR"; then
  echo "Error: unable to create dir $TMPDIR" 1>&2
  exit 1
fi

if [ ! -d "$TARGET_DIR" ] && ! mkdir "$TARGET_DIR"; then
  echo "Error: unable to create dir '$TARGET_DIR'" 1>&2
  exit 1
fi

tmp_file=`mktemp "$TMP_DIR/tmp_script.XXXXXX"`
if [ $? -ne 0 ]; then
  echo "Error: unable to create temporary file" 1>&2
  exit 1
fi
trap 'rm -f "$tmp_file"' EXIT

cat >"$tmp_file"
if [ $? -ne 0 ]; then
  echo "Error: unable to save script contents." 1>&2
  exit 1
fi

if ! chmod 700 "$tmp_file"; then
  echo "Error: unable to chmod file $tmp_file" 1>&2
  exit 1
fi

if ! mv -f "$tmp_file" "$target_file"; then
  echo "Error: unable to move temp file '$tmp_file' to '$target_file'" 1>&2
  exit 1
fi

exit 0
